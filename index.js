(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Base:()=>l,Blank:()=>s,Checkbox:()=>f,Constant:()=>h,Dropdown:()=>v,Output:()=>g});var n={};t.r(n),t.d(n,{Character:()=>x});var o={};t.r(o),t.d(o,{Test:()=>T,castBloodMagic:()=>E});var r={};t.r(r),t.d(r,{fifthEdition:()=>n});var i={};t.r(i),t.d(i,{dialogs:()=>o,elements:()=>e,models:()=>r});var a,u=function(){function t(t){var e=this,n=t.title,o=t.elements,r=t.buttons,i=t.template;this.buttons={},this.d="",this.title=n,this.elements=Object.values(o),this.elementKeys=Object.keys(o),this.html=('<form id="ndia">'+this.elements.reduce((function(t,e){return e.apply(t)}),i)+"</form>").replaceAll(/\#\{[^{]*\}/g,""),Object.entries(r).forEach((function(t){var n=t[0],o=t[1];o.default&&(e.d=n);var r=o.callback?function(t){return o.callback(e.extract(t))}:void 0;e.buttons[n]={icon:'<i class="fas fa-'+o.icon+'"></i>',label:o.label,jQuery:!0,callback:r}}));var a=function(t){return function(){var n,o={},r=10;do{if(n=o,e.elements.forEach((function(n){o=e.extract(t);try{n.update(t,o)}catch(n){console.error("Failed to update: "+n.key+" with:",o)}})),r--<0)break}while(JSON.stringify(o)!==JSON.stringify(n))}};this.dialog=new Dialog({title:this.title,content:this.html,buttons:this.buttons,default:this.d,render:function(t){t.find("#ndia")[0].addEventListener("change",(function(){queueMicrotask(a(t))}),!0),a(t)(),e.elements.forEach((function(e){return e.onRender(t)}))}})}return t.prototype.render=function(){this.dialog.render(!0)},t.prototype.extract=function(t){var e=this;return Object.fromEntries(this.elements.map((function(n,o){return[e.elementKeys[o],n.extract(t)]})))},t}(),l=function(){function t(t){this.injectHtml="",this.key=t}return t.prototype.update=function(t,e){},t.prototype.onRender=function(t){},t.prototype.getElement=function(t){var e=t.find("#"+this.key);return 0===e.length&&console.error("could not find element "+this.key),e},t.prototype.apply=function(t){return t.replaceAll("#{"+this.key+"}",this.injectHtml)},t}(),c=(a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=function(t){function e(e){var n=t.call(this,e)||this;return n.injectHtml="",n}return c(e,t),e.prototype.extract=function(){},e}(l),p=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),f=function(t){function e(e,n){var o=t.call(this,e)||this;return o.injectHtml="<div> "+(n.label?'<label for="'+o.key+'">'+n.label+"</label>":"")+' <input\n        type=checkbox\n        id="'+o.key+'"\n        name="'+o.key+'"\n        '+(n.default?"checked":"")+"\n        "+(n.disabled?"disabled":"")+"\n      ></input>\n    </div>",o}return p(e,t),e.prototype.extract=function(t){return this.getElement(t)[0].checked},e}(l),d=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),h=function(t){function e(e,n){var o=t.call(this,e)||this;return o.value=n,o}return d(e,t),e.prototype.apply=function(t){return t},e.prototype.extract=function(t){return this.value},e}(l),b=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),y=function(){return(y=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},v=function(t){function e(e,n){var o=t.call(this,e)||this;return o.params=n,o.injectHtml="\n    "+(o.params.label?'<label for="'+o.key+'">'+o.params.label+"</label>":"")+'\n    <select id="'+o.key+'" name="'+o.key+'">'+o.params.options.map((function(t){return"<option "+(t.value===n.selected?"selected":"")+">"+t.label+"</option>"}))+"</select>\n    ",o}return b(e,t),e.prototype.extract=function(t){return this.params.options[this.getElement(t)[0].selectedIndex].value},e}(l),m=function(t){function e(e,n){var o,r=t.call(this,e,y(y({},n),{selected:null===(o=n.r)||void 0===o?void 0:o.getKey(),options:Object.keys(n.char.resorces).map((function(t){var e;return{value:t,label:(null===(e=n.char)||void 0===e?void 0:e.resorces[t].label)||t}}))}))||this;return r.r=n.r,r}return b(e,t),e.prototype.onRender=function(e){var n=this;t.prototype.onRender.call(this,e),this.getElement(e)[0].addEventListener("change",(function(){var t;null===(t=n.r)||void 0===t||t.select(n.extract(e))}))},e}(v),_=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),g=function(t){function e(e,n){var o=t.call(this,e)||this;return o.update=function(t,e){o.updateData&&(o.value=o.updateData(e),o.getElement(t)[0].value=o.render(o.value))},o.updateData=n.update,o.render=n.render||o.interpolate,o.label=n.label,o.value=n.default,o.injectHtml="\n    "+(o.label?'<label for="'+o.key+'">'+o.label+"</label>":"")+'\n    <output id="'+o.key+'"></output>',o}return _(e,t),e.prototype.interpolate=function(t){return t+""},e.prototype.extract=function(){return this.value},e}(l),w=function(){function t(t){this.hp=t.hp}return t.init=function(t,e){var n={};return n.hp={get:function(){return t.attributes.hp.value||0},set:function(n){var o,r;t.attributes.hp.value=n,null!==(o=(r=e.attributes).hp)&&void 0!==o||(r.hp={}),e.attributes.hp.value=n}},e.attributes={},n},t}(),O=function(){function t(t,e){var n=this;this.rx=e,this.current="primary",Object.entries(t).forEach((function(t){var e=t[0],o=t[1];n.match(o)&&(n.current=e)}))}return t.prototype.match=function(t){var e;return!!(null===(e=t.label)||void 0===e?void 0:e.match(this.rx))},t}(),C=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),j=function(t){function e(e){return t.call(this,e,/blood.*points?/gi)||this}return C(e,t),e}(O),k=function(t){function e(e){return t.call(this,e,/corruption/gi)||this}return C(e,t),e}(O),P=function(){function t(t,e){this.bloodPoints=(null==e?void 0:e.bloodPoints)||new j(t),this.corruption=(null==e?void 0:e.corruption)||new k(t)}return t.init=function(e,n){var o,r=e.resources,i={},a={},u=new t(r,null===(o=e.nova)||void 0===o?void 0:o.resources),l={},c=function(t){var e=t;l[e]={get:function(){return r[u[e].current].value||0},getKey:function(){return u[e].current},select:function(t){u[e].current=t,i[e]={current:t}},set:function(t){var n;r[u[e].current].value=t,(a[n=u[e].current]||(a[n]={})).value=t}}};for(var s in new t(r,{}))c(s);return n.nova||(n.nova={}),n.nova.resources=i,n.resources=a,l},t}(),x=function(){function t(t){this.actor=t,this.updates={},this.customResources=P.init(this.actor.data.data,this.updates),this.attributes=w.init(this.actor.data.data,this.updates)}return Object.defineProperty(t.prototype,"resorces",{get:function(){return this.actor.data.data.resources},enumerable:!1,configurable:!0}),t.prototype._reset=function(){delete this.actor.data.data.nova,this.updates={nova:!1},this.save()},Object.defineProperty(t.prototype,"name",{get:function(){return this.actor.data.name},enumerable:!1,configurable:!0}),t.prototype.save=function(t){if(t)return console.info({data:this.updates});this.actor.update({data:this.updates}),this.updates={}},t}(),E=function(t){var e;t||(t=null===(e=game.user)||void 0===e?void 0:e.character);var n=t?new x(t):void 0,o=[4,8,12,16,20,25,30,35,40],r={costs:new h("Costs",o),level:new v("Level",{label:"Spell Level:",options:o.map((function(t,e){return{label:""+(e+1),value:e+1}}))}),bp:new f("BloodPoints",{label:"Spend blood point to reduce cost?"}),bpCost:new g("BloodCost",{label:"Blood point:",update:function(t){return t.bp?1:0},default:0}),hpCost:new g("HealthCost",{label:"HP:",update:function(t){return t.costs[t.level-1]-3*t.bpCost},default:0}),cCost:new g("CorruptionCost",{label:"Corruption:",update:function(t){return Math.floor(t.hpCost/2)},default:0}),chat:new f("SendToChat",{label:"Send to chat?",default:!0}),update:new f("Update",{label:"Send updates to character sheet?",default:!!n,disabled:!n})};return n&&(r.bpCurr=new g("BloodCurrent",{label:"/",update:n.customResources.bloodPoints.get,default:0}),r.cCurr=new g("CorruptionCurrent",{label:"/",update:n.customResources.corruption.get,default:0}),r.hpCurr=new g("HealthCurrent",{label:"/",update:n.attributes.hp.get,default:0}),r.bpAttr=new m("BloodAttr",{label:"Resource for Bloodpoints:",char:n,r:n.customResources.bloodPoints}),r.cAttr=new m("CorruptionAttr",{label:"Resource for Corruption:",char:n,r:n.customResources.corruption})),new u({title:n?n.name+" casting BloodMagic":"Cast BloodMagic",elements:r,buttons:{confirm:{icon:"skull",label:"Cast"+(n?" as "+(null==n?void 0:n.name):"!"),callback:function(t){if(t.update&&n){var e=n.customResources.bloodPoints;e.set(e.get()-t.bpCost);var o=n.customResources.corruption;o.set(o.get()+t.cCost);var r=n.attributes.hp;r.set(r.get()-t.hpCost),n.save(!0),n.save()}t.chat&&ChatMessage.create({user:game.user._id,content:(n?n.name:"I")+" cast a blood magic spell at level "+t.level+" by spending "+t.hpCost+" health and "+t.bpCost+" blood points",type:CONST.CHAT_MESSAGE_TYPES.EMOTE})}}},template:"<h1>Select spell level</h1>\n#{Level} #{BloodPoints}\n\n<h2>Costs:</h2>\n<ul>\n  <li>#{BloodCost} #{BloodCurrent}</li>\n  <li>#{HealthCost} #{HealthCurrent}</li>\n  <li>#{CorruptionCost} #{CorruptionCurrent}</li>\n</ul>\n\n<h2>Options:</h2>\n<div>#{BloodAttr}</div>\n<div>#{CorruptionAttr}</div>\n\n#{SendToChat} #{Update}\n"})},S={yay:{default:!0,label:"The default button"},echo:{default:!0,icon:"play",label:"Echo!",callback:function(t){console.info("TheBox: "+(t.theBox?"yes":"no"))}}},B={theBox:new f("theBox",{label:"This is a test checkbox"})},T=new u({title:"A test",elements:B,buttons:S,template:""});Hooks.once("ready",(function(){window.novaAPI=i,setTimeout((function(){return $(".notification:contains(requires a minimum screen resolution)").hide()}))}))})();
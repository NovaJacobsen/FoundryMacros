(()=>{"use strict";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{Base:()=>c,Blank:()=>p,Checkbox:()=>d,Constant:()=>v,Dropdown:()=>m,ImagePicker:()=>_,Output:()=>C,TextInput:()=>j});var n={};t.r(n),t.d(n,{Character:()=>H});var o={};t.r(o),t.d(o,{Test:()=>I,castBloodMagic:()=>B,spellResearch:()=>R});var r={};t.r(r),t.d(r,{fifthEdition:()=>n});var i={};t.r(i),t.d(i,{NovaDialog:()=>u,dialogs:()=>o,elements:()=>e,models:()=>r});var a,l=/\#\{[^{]*\}/g,u=function(){function t(t){var e=this,n=t.title,o=t.elements,r=t.buttons,i=t.template,a=t.options;this.buttons={},this.d="",this.options=Dialog.defaultOptions,(null==a?void 0:a.height)&&(this.options.height=a.height),(null==a?void 0:a.width)&&(this.options.width=a.width),this.title=n,this.elements=Object.values(o),this.elementKeys=Object.keys(o),this.html=('<form id="ndia">'+this.elements.reduce((function(t,e){return e.apply(t)}),i)+"</form>").replaceAll(l,""),Object.entries(r).forEach((function(t){var n,o=t[0],r=t[1];r.default&&(e.d=o);var i=r.callback?function(t){return r.callback(e.extract(t))}:void 0;e.buttons[o]={icon:'<i class="fas fa-'+(null===(n=r.icon)||void 0===n?void 0:n.toLocaleLowerCase())+'"></i>',label:r.label,jQuery:!0,callback:i}}));var u=function(t){return function(){var n,o={},r=10;do{if(n=o,e.elements.forEach((function(n){o=e.extract(t);try{n.update(t,o)}catch(t){console.error("Failed to update: "+n.key+" with:",o,t)}})),r--<0)break}while(JSON.stringify(o)!==JSON.stringify(n))}};this.dialog=new Dialog({title:this.title,content:this.html,buttons:this.buttons,default:this.d,render:function(t){t.find("#ndia")[0].addEventListener("change",(function(){queueMicrotask(u(t))}),!0),u(t)(),e.elements.forEach((function(e){return e.onRender(t)}))}},this.options)}return t.prototype.render=function(){this.dialog.render(!0)},t.prototype.extract=function(t){var e=this;return Object.fromEntries(this.elements.map((function(n,o){return[e.elementKeys[o],n.extract(t)]})))},t}(),c=function(){function t(t){this.injectHtml="",this.key=t}return t.prototype.update=function(t,e){},t.prototype.onRender=function(t){},t.prototype.getElement=function(t){var e=t.find("#"+this.key);return 0===e.length&&console.error("could not find element "+this.key),e[0]},t.prototype.labelHtml=function(t){return t?'<label for="'+this.key+'">'+t+"</label>":""},t.prototype.apply=function(t){return t.replaceAll("#{"+this.key+"}",this.injectHtml)},t}(),s=(a=function(t,e){return(a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function n(){this.constructor=t}a(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),p=function(t){function e(e){var n=t.call(this,e)||this;return n.injectHtml="",n}return s(e,t),e.prototype.extract=function(){},e}(c),f=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),d=function(t){function e(e,n){var o=t.call(this,e)||this;return o.injectHtml=o.labelHtml(n.label)+' <input\n        type=checkbox\n        id="'+o.key+'"\n        name="'+o.key+'"\n        '+(n.default?"checked":"")+"\n        "+(n.disabled?"disabled":"")+"\n      ></input>",o}return f(e,t),e.prototype.extract=function(t){return this.getElement(t).checked},e}(c),h=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),v=function(t){function e(e,n){var o=t.call(this,e)||this;return o.value=n,o}return h(e,t),e.prototype.apply=function(t){return t},e.prototype.extract=function(t){return this.value},e}(c),y=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),b=function(){return(b=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)},m=function(t){function e(e,n){var o=t.call(this,e)||this;return o.params=n,o.injectHtml=o.labelHtml(n.label)+'\n    <select id="'+o.key+'" name="'+o.key+'">'+o.params.options.map((function(t){return"<option "+(t.value===n.selected?"selected":"")+">"+t.label+"</option>"}))+"</select>\n    ",o}return y(e,t),e.prototype.extract=function(t){return this.params.options[this.getElement(t).selectedIndex].value},e}(c),w=function(t){function e(e,n){var o,r=t.call(this,e,b(b({},n),{selected:null===(o=n.r)||void 0===o?void 0:o.getKey(),options:Object.keys(n.char.resorces).map((function(t){var e;return{value:t,label:(null===(e=n.char)||void 0===e?void 0:e.resorces[t].label)||t}}))}))||this;return r.r=n.r,r}return y(e,t),e.prototype.onRender=function(e){var n=this;t.prototype.onRender.call(this,e),this.getElement(e).addEventListener("change",(function(){var t;null===(t=n.r)||void 0===t||t.select(n.extract(e))}))},e}(m),g=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),_=function(t){function e(e,n){var o,r=t.call(this,e)||this;return null!=n||(n={}),r.path=null!==(o=n.default)&&void 0!==o?o:CONST.DEFAULT_TOKEN,r.injectHtml=r.labelHtml(n.label)+'\n    <img  id="'+r.key+'" name="'+r.key+'" src="'+n.default+'"></img>',r}return g(e,t),e.prototype.extract=function(){return this.path},e.prototype.onRender=function(e){var n=this;t.prototype.onRender.call(this,e),this.getElement(e).addEventListener("click",(function(t){var e=t.currentTarget;new FilePicker({current:n.path,type:"image",title:"Select icon for Spell",callback:function(t){n.path=t,e.src=t}}).browse()}))},e}(c),O=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),C=function(t){function e(e,n){var o=t.call(this,e)||this;return o.update=function(t,e){o.updateData&&(o.value=o.updateData(e),o.getElement(t).value=o.render(o.value))},o.updateData=n.update,o.render=n.render||o.interpolate,o.label=n.label,o.value=n.default,o.injectHtml="\n    "+(o.label?'<label for="'+o.key+'">'+o.label+"</label>":"")+'\n    <output id="'+o.key+'"></output>',o}return O(e,t),e.prototype.interpolate=function(t){return t+""},e.prototype.extract=function(){return this.value},e}(c),k=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),j=function(t){function e(e,n){var o=t.call(this,e)||this;return null!=n||(n={}),o.injectHtml=o.labelHtml(n.label)+'\n    <input id="'+o.key+'" name="'+o.key+'" \n      type="text"\n      placeholder="'+n.placeholder+'"\n    ></input>',o}return k(e,t),e.prototype.extract=function(t){return this.getElement(t).value},e}(c),S=function(){function t(t){this.hp=t.hp}return t.init=function(t,e){var n={};return n.hp={get:function(){return t.attributes.hp.value||0},set:function(n){var o,r;t.attributes.hp.value=n,null!==(o=(r=e.attributes).hp)&&void 0!==o||(r.hp={}),e.attributes.hp.value=n}},e.attributes={},n},t}(),P=function(){function t(t,e){var n=this;this.rx=e,this.current="primary",Object.entries(t).forEach((function(t){var e=t[0],o=t[1];n.match(o)&&(n.current=e)}))}return t.prototype.match=function(t){var e;return!!(null===(e=t.label)||void 0===e?void 0:e.match(this.rx))},t}(),E=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n])})(e,n)};return function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Class extends value "+String(n)+" is not a constructor or null");function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}}(),T=function(t){function e(e){return t.call(this,e,/blood.*points?/gi)||this}return E(e,t),e}(P),x=function(t){function e(e){return t.call(this,e,/corruption/gi)||this}return E(e,t),e}(P),A=function(){function t(t,e){this.bloodPoints=(null==e?void 0:e.bloodPoints)||new T(t),this.corruption=(null==e?void 0:e.corruption)||new x(t)}return t.init=function(e,n){var o,r=e.resources,i={},a={},l=new t(r,null===(o=e.nova)||void 0===o?void 0:o.resources),u={},c=function(t){var e=t;u[e]={get:function(){return r[l[e].current].value||0},getKey:function(){return l[e].current},select:function(t){l[e].current=t,i[e]={current:t}},set:function(t){var n;r[l[e].current].value=t,(a[n=l[e].current]||(a[n]={})).value=t}}};for(var s in new t(r,{}))c(s);return n.nova||(n.nova={}),n.nova.resources=i,n.resources=a,u},t}(),H=function(){function t(t){this.actor=t,this.updates={},this.customResources=A.init(this.actor.data.data,this.updates),this.attributes=S.init(this.actor.data.data,this.updates)}return Object.defineProperty(t.prototype,"resorces",{get:function(){return this.actor.data.data.resources},enumerable:!1,configurable:!0}),t.prototype._reset=function(){delete this.actor.data.data.nova,this.updates={nova:!1},this.save()},Object.defineProperty(t.prototype,"name",{get:function(){return this.actor.data.name},enumerable:!1,configurable:!0}),t.prototype.save=function(t){if(t)return console.info({data:this.updates});this.actor.update({data:this.updates}),this.updates={}},t}(),B=function(t){var e;t||(t=null===(e=game.user)||void 0===e?void 0:e.character);var n=t?new H(t):void 0,o=[4,8,12,16,20,25,30,35,40],r={costs:new v("Costs",o),level:new m("Level",{label:"Spell Level:",options:o.map((function(t,e){return{label:""+(e+1),value:e+1}}))}),bp:new d("BloodPoints",{label:"Spend blood point to reduce cost?"}),bpCost:new C("BloodCost",{label:"Blood point:",update:function(t){return t.bp?1:0},default:0}),hpCost:new C("HealthCost",{label:"HP:",update:function(t){return t.costs[t.level-1]-3*t.bpCost},default:0}),cCost:new C("CorruptionCost",{label:"Corruption:",update:function(t){return Math.floor(t.hpCost/2)},default:0}),chat:new d("SendToChat",{label:"Send to chat?",default:!0}),update:new d("Update",{label:"Send updates to character sheet?",default:!!n,disabled:!n})};return n&&(r.bpCurr=new C("BloodCurrent",{label:"/",update:n.customResources.bloodPoints.get,default:0}),r.cCurr=new C("CorruptionCurrent",{label:"/",update:n.customResources.corruption.get,default:0}),r.hpCurr=new C("HealthCurrent",{label:"/",update:n.attributes.hp.get,default:0}),r.bpAttr=new w("BloodAttr",{label:"Resource for Bloodpoints:",char:n,r:n.customResources.bloodPoints}),r.cAttr=new w("CorruptionAttr",{label:"Resource for Corruption:",char:n,r:n.customResources.corruption})),new u({title:n?n.name+" casting BloodMagic":"Cast BloodMagic",elements:r,buttons:{confirm:{icon:"skull",label:"Cast"+(n?" as "+(null==n?void 0:n.name):"!"),callback:function(t){if(t.update&&n){var e=n.customResources.bloodPoints;e.set(e.get()-t.bpCost);var o=n.customResources.corruption;o.set(o.get()+t.cCost);var r=n.attributes.hp;r.set(r.get()-t.hpCost),n.save(!0),n.save()}t.chat&&ChatMessage.create({user:game.user._id,content:(n?n.name:"I")+" cast a blood magic spell at level "+t.level+" by spending "+t.hpCost+" health and "+t.bpCost+" blood points",type:CONST.CHAT_MESSAGE_TYPES.EMOTE})}}},template:"<h1>Select spell level</h1>\n#{Level} #{BloodPoints}\n\n<h2>Costs:</h2>\n<ul>\n  <li>#{BloodCost} #{BloodCurrent}</li>\n  <li>#{HealthCost} #{HealthCurrent}</li>\n  <li>#{CorruptionCost} #{CorruptionCurrent}</li>\n</ul>\n\n<h2>Options:</h2>\n<div>#{BloodAttr}</div>\n<div>#{CorruptionAttr}</div>\n\n#{SendToChat} #{Update}\n"})},R=function(t){var e;t||(t=null===(e=game.user)||void 0===e?void 0:e.character);var n=t?new H(t):void 0,o={level:new m("Level",{label:"Spell Level:",options:new Array(10).fill(null).map((function(t,e){return 0===e?{label:"cantrip",value:0}:{label:""+e,value:e}}))}),custom:new d("CustomSpell",{label:"Is this a custom spell? (increases cost!)"}),weekly:new C("WeeklyCost",{label:"Per week: ",update:function(t){return t.custom?500:200},default:0}),time:new C("Time",{label:"Time: ",update:function(t){return 2*(t.level||1)},default:0}),total:new C("Total",{label:"Total: ",update:function(t){return t.weekly*(2*t.level||1)},default:0}),check:new C("Check",{label:"Skill check (Arcana): ",update:function(t){return t.custom?5*(t.level||1)+20:25},default:0}),image:new _("Image",{default:"icons/svg/light.svg"}),name:new j("Name",{placeholder:"Spell Name"})};return new u({title:"Creating spell",elements:o,buttons:{confirm:{icon:"Magic",label:"Start Project",callback:function(t){ChatMessage.create({user:game.userId,content:"<h3>"+(n?n.name:"")+" created a new spell research!</h3>\n      <div>It will require <b>"+t.time+"</b> weeks to finish, and <b>"+t.total+"</b> to fully finance (at a rate of <b>"+t.weekly+"</b> per week)\n      </div>\n      <div>\n      The first skill check will be arcana DC <b>"+t.check+"</b> after the required time.\n      </div>\n      <div>\n      Reduce this by 2 and attempt again after a week until the check is passed\n      </div>\n      <div>\n      Once the check is passed add <b>"+(t.name||"the researched spell")+"</b> to your spell list\n      </div>",type:CONST.CHAT_MESSAGE_TYPES.EMOTE})}}},template:'<h1>Spell research and creation</h1>\n\n<div>#{Level}</div>\n<div>#{CustomSpell}</div>\n\n<div style="display: flex; align-items: center">\n  <div style="max-width: 20%">#{Image}</div>\n  #{Name}\n</div>\n<h2>Requirements:</h2>\n- You need access to an extensive library of arcane research\n\n<h2>Cost</h2>\n<div>#{WeeklyCost} GP</div>\n<div>#{Time} weeks</div>\n<div>#{Total}</div>\n<div>#{Check}</div>\n',options:{height:420}})},M={yay:{default:!0,label:"The default button"},echo:{default:!0,icon:"play",label:"Echo!",callback:function(t){console.info("TheBox: "+(t.theBox?"yes":"no"))}}},L={theBox:new d("theBox",{label:"This is a test checkbox"})},I=new u({title:"A test",elements:L,buttons:M,template:""});Hooks.once("ready",(function(){window.novaAPI=i,setTimeout((function(){return $(".notification:contains(requires a minimum screen resolution)").hide()}))}))})();